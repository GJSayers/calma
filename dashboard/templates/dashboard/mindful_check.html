{% load crispy_forms_tags %}
{% if request.user.is_authenticated %}
<div class="container">
  <div id="currentMindfulCheckResults" class="row"></div>
</div>
<form method="POST" class="uniForm">
  {% csrf_token %} {{ form }}
  <input type="submit" value="Submit" />
</form>
<form action="">
  <input id="mindfulCheckSubmit" type="submit" value="See Chart" />
</form>

<div class="container">
  <div class="row">
    <div class="col">
      <h2 id="todaysDate"></h2>
    </div>
  </div>
  <div class="row">
    <div class="col">
        <div id="pieChartContainer" style="height: 300px; width: 100%"></div>
    </div>
  </div>
  <div class="row">
    <div class="col">
      <div id="submittedData"></div>
    </div>
  </div>
</div>
{% else %}
<h1>Please Log In To See This Page</h1>
{% endif %}


<!-- <script src="https://d3js.org/d3.v7.min.js"></script> -->

<script
  type="text/javascript"
  src="https://canvasjs.com/assets/script/canvasjs.min.js"
></script>
<script>
  let data = {
    model: {{ data.model|safe }}
  }
  const currentDate = document.getElementById('todaysDate');
  const dataDisplayContainer = document.getElementById('submittedData');
  const mindCheckSubmit = document.getElementById('mindfulCheckSubmit');
  const currentMindfulCheckResults = document.getElementById(
    'currentMindfulCheckResults'
  );
  const mindfulScales = document.querySelectorAll('.mindfulScale');

  let mindResults = [
    {
      indexLabel: 'Purpose',
      y: '0',
    },
    { indexLabel: 'Emotional', y: '0' },
    { indexLabel: 'Financial', y: '0' },
    { indexLabel: 'Physical', y: '0' },
    { indexLabel: 'Social', y: '0' },
    { indexLabel: 'Community', y: '0' },
    { indexLabel: 'Career', y: '0' },
    { indexLabel: 'Overall', y: '0' },
  ];

  mindResults.forEach((mindResult) => {
    currentMindfulCheckResults.innerHTML += `
        <div
        >
            <p class="m-0">${mindResult.indexLabel}: ${mindResult.y}</p>
        </div>
    `;
  });

  mindfulScales.forEach((mindfulScale) => {
    mindfulScale.addEventListener('change', () => {
      //for (let [key, value] of Object.entries(mindResults)) {

      //}
      currentMindfulCheckResults.innerHTML = '';
      mindResults.forEach((mindResult) => {
        if (mindfulScale.id == mindResult.indexLabel) {
          mindResult.y = mindfulScale.value;
        }
        currentMindfulCheckResults.innerHTML += `
            <div>
                <p class="m-0">${mindResult.indexLabel}: ${mindResult.y}</p>
            </div>
          `;
      });
    });
  });

  window.onload = function () {};

  let setResult = false,
    allAverages = [],
    daysPassed = 1;
  let todaysDate = new Date().getDay();

  mindCheckSubmit.addEventListener('click', (e) => {
    console.log(mindResults);
    e.preventDefault();
    console.log(Object.keys(data.model[0].fields));

    let chartMindResults = [];

    let latestResults = data.model[data.model.length - 1].fields;

    for (const [key, value] of Object.entries(latestResults)) {
      chartMindResults.push({indexLabel: key, y: value})
    }
    chartMindResults.splice(0, 2)
    chartMindResults.forEach(res => console.log('HERE: ' + res));

    var pieChart = new CanvasJS.Chart('pieChartContainer', {
      title: {
        text: "Today's Results",
      },
      legend: {
        maxWidth: 350,
        itemWidth: 120,
      },
      data: [
        {
          type: 'pie',
          showInLegend: true,
          legendText: '{indexLabel}',
          dataPoints: chartMindResults,
        },
      ],
    });
    pieChart.render();

    let averageRes = [];
    console.log(chartMindResults);
    let sum = chartMindResults.reduce(function (accumulator, currentValue) {
      return accumulator + parseInt(currentValue.y);
    }, 0);
    mean = sum / 8
    console.log('mean: ', mean);

    let date = new Date(),
      day = date.getDate(),
      month = date.getMonth(),
      year = date.getFullYear();

    currentDate.innerHTML = `Results of ${day}/${month+1}/${year}`;
    dataDisplayContainer.innerHTML = ''
    dataDisplayContainer.innerHTML += `
    <div class="
                w-100
                border border-1
                rounded
                d-flex
                align-items-center
                justify-content-center
                "
                style="height: 100px; background-color: #f5f5f5; font-size: 24px;"
            >
                <p class="m-0">average: ${mean}</p>
            </div>
          `;
    chartMindResults.forEach(res => {

      dataDisplayContainer.innerHTML += `
      <div class="
                w-100
                border border-1
                rounded
                d-flex
                align-items-center
                justify-content-center
                "
                style="height: 100px; background-color: #f5f5f5; font-size: 24px;"
            >
                <p class="m-0">${res.indexLabel}: ${res.y}</p>
            </div>
      `;
    });
    
  });
</script>
